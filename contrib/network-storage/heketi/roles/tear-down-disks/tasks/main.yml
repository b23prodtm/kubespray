---
- name: "Install lvm utils (RedHat)"
  become: yes
  yum:
    name: "lvm2"
    state: "present"
  when: "ansible_os_family == 'RedHat'"

- name: "Install lvm utils (Debian)"
  become: yes
  apt:
    name: "lvm2"
    state: "present"
  when: "ansible_os_family == 'Debian'"

- name: "Get volume group information."
  become: yes
  shell: "pvs {{ disk_volume_device_1 }} --option vg_name | tail -n+2"
  register: "volume_groups"
  ignore_errors: yes
  changed_when: false

- name: "Remove volume groups."
  become: yes
  command: "vgremove {{ volume_group }} --yes"
  with_items: "{{ volume_groups.stdout_lines }}"
  loop_control: { loop_var: "volume_group" }

- name: "Remove physical volume from cluster disks."
  become: yes
  command: "pvremove {{ disk_volume_device_1 }} --yes"
  ignore_errors: yes

- name: "Remove lvm utils (RedHat)"
  become: yes
  yum:
    name: "lvm2"
    state: "absent"
  when: "ansible_os_family == 'RedHat'"

- name: "Remove lvm utils (Debian)"
  become: yes
  apt:
    name: "lvm2"
    state: "absent"
  when: "ansible_os_family == 'Debian'"
